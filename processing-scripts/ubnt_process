#!/usr/bin/env python
import os
import sys
import shutil
import tempfile
import subprocess
import requests
from dotenv import load_dotenv
from datetime import date, datetime
from dateutil import parser


if __name__ == "__main__":
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    logging_handler = logging.StreamHandler(sys.stdout)
    log_format = '[%(asctime)s] {%(filename)s:%(lineno)d} ' \
                 '%(levelname)s - %(message)s'
    logging.basicConfig(
        level=logging.DEBUG,
        format=log_format,
        handlers=[logging_handler]
    )
    logger.info("Initialized.")
    config, verify_ssl = load_config()
    # Get the UBV files
    logger.info("Collecting UBV files.")
    ubv_files = get_ubv_files(config['paths']['ubv_files'])
    # Make our temporary path
    TEMP_PATH = tempfile.mkdtemp(dir=config['paths']['ubv_temp']])
    logger.debug(f"Temporary Path: {TEMP_PATH}")
    # Process the files
    logger.info("Processing UBV Files")
    process_ubv_files(
        ubv_files = ubv_files,
        tmp_path = TEMP_PATH,
        output_path = config['paths']['ubv_output'],
        archive_path = config['paths']['ubv_archive']
    )
    logger.info("Completed Process")